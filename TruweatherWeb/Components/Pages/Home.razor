@page "/"
@attribute [Authorize]
@inject HttpClientWrapper Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Dashboard - Truweather</PageTitle>

<h3 class="mb-4">Dashboard</h3>

@if (_loading)
{
    <LoadingSpinner Message="Loading weather data..." />
}
else if (_error != null)
{
    <ErrorAlert Message="@_error" OnDismiss="() => _error = null" />
}
else
{
    @if (_currentWeather != null)
    {
        <WeatherCard LocationName="@_currentWeather.LocationName"
                     Temperature="@_currentWeather.Temperature.ToString("F0")"
                     Condition="@_currentWeather.Condition"
                     FeelsLike="@_currentWeather.FeelsLike.ToString("F0")"
                     Humidity="@_currentWeather.Humidity.ToString()"
                     WindSpeed="@($"{_currentWeather.WindSpeed:F1} m/s")" />
    }

    @if (_forecast?.Days is { Count: > 0 })
    {
        <h5 class="mt-4 mb-3">7-Day Forecast</h5>
        <div class="row g-2">
            @foreach (var day in _forecast.Days)
            {
                <div class="col-6 col-md-3 col-lg">
                    <ForecastDayCard DayName="@day.Date.ToString("ddd")"
                                     HighTemp="@day.MaxTemperature.ToString("F0")"
                                     LowTemp="@day.MinTemperature.ToString("F0")"
                                     Condition="@day.Condition" />
                </div>
            }
        </div>
    }

    @if (_locations is { Count: > 0 })
    {
        <h5 class="mt-4 mb-3">Saved Locations</h5>
        <div class="row g-3">
            @foreach (var loc in _locations)
            {
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">
                                @loc.LocationName
                                @if (loc.IsDefault)
                                {
                                    <span class="badge bg-primary ms-2">Default</span>
                                }
                            </h6>
                            <small class="text-muted">@loc.Latitude, @loc.Longitude</small>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center mt-5 py-4">
            <p class="text-muted">No saved locations yet.</p>
            <a href="/locations" class="btn btn-primary">Add a Location</a>
        </div>
    }
}

@code {
    private CurrentWeatherDto? _currentWeather;
    private ForecastDto? _forecast;
    private List<SavedLocationDto>? _locations;
    private string? _error;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _locations = await Http.GetAsync<List<SavedLocationDto>>(ApiEndpoints.WeatherLocations);

            var defaultLocation = _locations?.FirstOrDefault(l => l.IsDefault) ?? _locations?.FirstOrDefault();

            if (defaultLocation != null)
            {
                var query = $"?lat={defaultLocation.Latitude}&lon={defaultLocation.Longitude}";

                var weatherTask = Http.GetAsync<CurrentWeatherDto>(ApiEndpoints.WeatherCurrent + query);
                var forecastTask = Http.GetAsync<ForecastDto>(ApiEndpoints.WeatherForecast + query);

                await Task.WhenAll(weatherTask, forecastTask);

                _currentWeather = weatherTask.Result;
                _forecast = forecastTask.Result;
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
