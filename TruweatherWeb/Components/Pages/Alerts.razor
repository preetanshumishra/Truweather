@page "/alerts"
@attribute [Authorize]
@inject HttpClientWrapper Http
@rendermode InteractiveServer

<PageTitle>Alerts - Truweather</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">Weather Alerts</h3>
    <button class="btn btn-primary" @onclick="() => _showAddForm = !_showAddForm">
        @(_showAddForm ? "Cancel" : "Add Alert")
    </button>
</div>

<ErrorAlert Message="@_error" OnDismiss="() => _error = null" />

@if (_showAddForm)
{
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">New Alert</h5>
            <EditForm Model="_addModel" OnValidSubmit="AddAlert" FormName="addAlert">
                <DataAnnotationsValidator />
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Location</label>
                        <InputSelect class="form-select" @bind-Value="_addModel.SavedLocationId">
                            <option value="0">Select location...</option>
                            @if (_locations != null)
                            {
                                @foreach (var loc in _locations)
                                {
                                    <option value="@loc.Id">@loc.LocationName</option>
                                }
                            }
                        </InputSelect>
                        <ValidationMessage For="() => _addModel.SavedLocationId" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Type</label>
                        <InputSelect class="form-select" @bind-Value="_addModel.AlertType">
                            <option value="">Select type...</option>
                            <option value="Temperature">Temperature</option>
                            <option value="Wind">Wind</option>
                            <option value="Humidity">Humidity</option>
                            <option value="Precipitation">Precipitation</option>
                        </InputSelect>
                        <ValidationMessage For="() => _addModel.AlertType" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Condition</label>
                        <InputSelect class="form-select" @bind-Value="_addModel.Condition">
                            <option value="">Select...</option>
                            <option value="above">Above</option>
                            <option value="below">Below</option>
                            <option value="equals">Equals</option>
                        </InputSelect>
                        <ValidationMessage For="() => _addModel.Condition" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Threshold</label>
                        <InputNumber class="form-control" @bind-Value="_addModel.Threshold" />
                        <ValidationMessage For="() => _addModel.Threshold" />
                    </div>
                </div>
                <button type="submit" class="btn btn-success mt-3" disabled="@_saving">Save</button>
            </EditForm>
        </div>
    </div>
}

@if (_loading)
{
    <LoadingSpinner />
}
else if (_alerts is { Count: > 0 })
{
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Location</th>
                    <th>Type</th>
                    <th>Condition</th>
                    <th>Threshold</th>
                    <th>Enabled</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var alert in _alerts)
                {
                    <tr>
                        <td>@GetLocationName(alert.SavedLocationId)</td>
                        <td>@alert.AlertType</td>
                        <td>@alert.Condition</td>
                        <td>@alert.Threshold</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" checked="@alert.IsEnabled"
                                       @onchange="() => ToggleAlert(alert)" />
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(alert)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <p class="text-muted text-center mt-4">No alerts configured. Create one to get notified.</p>
}

<ConfirmDialog Visible="_deleteTarget != null"
               Title="Delete Alert"
               Message="Delete this alert? This cannot be undone."
               OnConfirm="DeleteConfirmed"
               OnCancel="() => _deleteTarget = null" />

@code {
    private List<WeatherAlertDto>? _alerts;
    private List<SavedLocationDto>? _locations;
    private AlertFormModel _addModel = new();
    private WeatherAlertDto? _deleteTarget;
    private string? _error;
    private bool _loading = true;
    private bool _saving;
    private bool _showAddForm;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var alertsTask = Http.GetAsync<List<WeatherAlertDto>>(ApiEndpoints.WeatherAlerts);
            var locationsTask = Http.GetAsync<List<SavedLocationDto>>(ApiEndpoints.WeatherLocations);
            await Task.WhenAll(alertsTask, locationsTask);
            _alerts = alertsTask.Result;
            _locations = locationsTask.Result;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private string GetLocationName(int locationId) =>
        _locations?.FirstOrDefault(l => l.Id == locationId)?.LocationName ?? $"Location #{locationId}";

    private async Task AddAlert()
    {
        _saving = true;
        _error = null;

        try
        {
            var request = new CreateWeatherAlertRequest(
                _addModel.SavedLocationId, _addModel.AlertType, _addModel.Condition, _addModel.Threshold);
            await Http.PostAsync<WeatherAlertDto>(ApiEndpoints.WeatherAlerts, request);
            _addModel = new();
            _showAddForm = false;
            _alerts = await Http.GetAsync<List<WeatherAlertDto>>(ApiEndpoints.WeatherAlerts);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task ToggleAlert(WeatherAlertDto alert)
    {
        try
        {
            var request = new UpdateWeatherAlertRequest(
                alert.AlertType, alert.Condition, alert.Threshold, !alert.IsEnabled);
            await Http.PutAsync<WeatherAlertDto>(ApiEndpoints.WeatherAlertDetails(alert.Id), request);
            _alerts = await Http.GetAsync<List<WeatherAlertDto>>(ApiEndpoints.WeatherAlerts);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private void ConfirmDelete(WeatherAlertDto alert) => _deleteTarget = alert;

    private async Task DeleteConfirmed()
    {
        if (_deleteTarget == null) return;

        try
        {
            await Http.DeleteAsync(ApiEndpoints.WeatherAlertDetails(_deleteTarget.Id));
            _deleteTarget = null;
            _alerts = await Http.GetAsync<List<WeatherAlertDto>>(ApiEndpoints.WeatherAlerts);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            _deleteTarget = null;
        }
    }

    private class AlertFormModel
    {
        [System.ComponentModel.DataAnnotations.Range(1, int.MaxValue, ErrorMessage = "Select a location")]
        public int SavedLocationId { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Type is required")]
        public string AlertType { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Condition is required")]
        public string Condition { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required]
        public decimal Threshold { get; set; }
    }
}
